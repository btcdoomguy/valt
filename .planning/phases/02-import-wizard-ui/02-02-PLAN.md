---
phase: 02-import-wizard-ui
plan: 02
type: execute
---

<objective>
Implement the content for all 5 wizard steps: File Selection, Account Mapping, Category Preview, Summary, and Progress placeholder.

Purpose: Complete the Import Wizard UI so users can select a CSV file, review account/category mappings, and see a summary before importing.
Output: Fully functional 5-step wizard ready for Phase 3 (Import Execution) to hook into the import button.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-csv-parser-template/01-01-SUMMARY.md
@.planning/phases/02-import-wizard-ui/02-01-SUMMARY.md (after Plan 01 completes)

**Tech stack available:** CsvHelper, CommunityToolkit.Mvvm, Avalonia 11.3
**Established patterns:** ValtModalViewModel, file picker via StorageProvider, IAccountQueries, ICategoryQueries
**Key files:**
@src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardViewModel.cs
@src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardView.axaml
@src/Valt.Infra/Services/CsvImport/ICsvImportParser.cs
@src/Valt.Infra/Services/CsvImport/ICsvTemplateGenerator.cs
@src/Valt.Infra/Services/CsvImport/CsvImportRow.cs
@src/Valt.Infra/Modules/Budget/Accounts/Queries/IAccountQueries.cs
@src/Valt.Infra/Modules/Budget/Categories/Queries/ICategoryQueries.cs
@src/Valt.UI/Views/Main/Modals/InitialSelection/InitialSelectionViewModel.cs (file picker pattern)

**Constraining decisions from Phase 1:**
- CSV parser collects row-level errors without throwing (partial success support)
- Template includes 7 sample rows covering all 6 transaction types
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Step 1 - File Selection</name>
  <files>src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardViewModel.cs, src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardView.axaml, src/Valt.UI/Lang/language.resx, src/Valt.UI/Lang/language.pt-BR.resx</files>
  <action>
In ImportWizardViewModel, add Step 1 functionality:
- [RelayCommand] SelectFile() - opens file picker for CSV files (*.csv), stores path in SelectedFilePath, calls ParseFile()
- [RelayCommand] DownloadTemplate() - calls ICsvTemplateGenerator.Generate(), opens SaveFilePickerAsync to save as "valt-import-template.csv"
- Private ParseFile() method - calls ICsvImportParser.Parse(File.OpenRead(SelectedFilePath)), stores in ParseResult
- [ObservableProperty] int _validRowCount, _errorCount (computed from ParseResult)
- [ObservableProperty] ObservableCollection&lt;string&gt; _parseErrors (from ParseResult.Errors)
- Update CanGoNext: on Step 1, require ParseResult != null && ParseResult.Rows.Count > 0

In ImportWizardView.axaml Step 1 DataTemplate:
- "Select CSV File" button bound to SelectFileCommand
- "Download Template" link/button bound to DownloadTemplateCommand
- Display selected file path when selected
- Display row count: "{ValidRowCount} valid rows" with success color
- If errors, display expandable error list with warning icon
- Brief instructions text explaining the expected CSV format

Add localization strings:
- ImportWizard_SelectFile: "Select CSV File" / "Selecionar Arquivo CSV"
- ImportWizard_DownloadTemplate: "Download Template" / "Baixar Modelo"
- ImportWizard_FileSelected: "File: {0}" / "Arquivo: {0}"
- ImportWizard_ValidRows: "{0} valid rows" / "{0} linhas validas"
- ImportWizard_Errors: "{0} errors" / "{0} erros"
- ImportWizard_Step1Instructions: "Select a CSV file matching the template format, or download the template to see the expected columns." / "Selecione um arquivo CSV no formato do modelo, ou baixe o modelo para ver as colunas esperadas."
  </action>
  <verify>Application compiles, clicking Select File opens picker, selecting valid CSV shows row count, Download Template saves file</verify>
  <done>Step 1 fully functional: file selection, template download, parse preview with errors</done>
</task>

<task type="auto">
  <name>Task 2: Implement Steps 2-3 - Account Mapping and Category Preview</name>
  <files>src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardViewModel.cs, src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardView.axaml, src/Valt.UI/Views/Main/Modals/ImportWizard/Models/AccountMappingItem.cs, src/Valt.UI/Views/Main/Modals/ImportWizard/Models/CategoryMappingItem.cs, src/Valt.UI/Lang/language.resx, src/Valt.UI/Lang/language.pt-BR.resx</files>
  <action>
Create mapping model classes:
- AccountMappingItem: CsvAccountName (string), ExistingAccount (AccountDTO?), IsNew (bool), AccountType (inferred from name suffix "[btc]" or "[currency]")
- CategoryMappingItem: CsvCategoryName (string), ExistingCategory (CategoryDTO?), IsNew (bool)

In ImportWizardViewModel:
- [ObservableProperty] ObservableCollection&lt;AccountMappingItem&gt; _accountMappings
- [ObservableProperty] ObservableCollection&lt;CategoryMappingItem&gt; _categoryMappings
- [ObservableProperty] int _newAccountCount, _existingAccountCount, _newCategoryCount, _existingCategoryCount
- ProcessMappings() method called when entering Step 2 from Step 1:
  - Extract unique account names from ParseResult.Rows (both AccountName and ToAccountName)
  - Query existing accounts via IAccountQueries
  - For each CSV account, find matching existing account or mark as new
  - Same for categories
- Override GoNext to call ProcessMappings() when leaving Step 1
- Validation: Block if any account name matches existing account name (per PROJECT.md constraint about preventing data merge)

In ImportWizardView.axaml Step 2 DataTemplate (Account Mapping):
- DataGrid or ItemsControl showing AccountMappings
- Columns: CSV Account Name, Status (New/Existing), Type (Fiat/BTC)
- New accounts highlighted with info color
- Warning if conflicts detected
- Summary: "X new accounts, Y existing"

In ImportWizardView.axaml Step 3 DataTemplate (Category Preview):
- Similar layout to Step 2 for categories
- DataGrid showing CategoryMappings
- Columns: CSV Category, Status (New/Existing)
- Summary: "X new categories, Y existing"

Add localization strings:
- ImportWizard_NewAccounts: "{0} new accounts" / "{0} novas contas"
- ImportWizard_ExistingAccounts: "{0} existing accounts" / "{0} contas existentes"
- ImportWizard_NewCategories: "{0} new categories" / "{0} novas categorias"
- ImportWizard_ExistingCategories: "{0} existing categories" / "{0} categorias existentes"
- ImportWizard_AccountConflict: "Account name conflicts with existing account" / "Nome da conta conflita com conta existente"
  </action>
  <verify>Navigating to Step 2 shows account mappings extracted from CSV, Step 3 shows category mappings</verify>
  <done>Steps 2-3 display account/category mappings with new vs existing status</done>
</task>

<task type="auto">
  <name>Task 3: Implement Steps 4-5 - Summary and Progress placeholder</name>
  <files>src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardViewModel.cs, src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardView.axaml, src/Valt.UI/Lang/language.resx, src/Valt.UI/Lang/language.pt-BR.resx</files>
  <action>
In ImportWizardViewModel:
- [ObservableProperty] int _totalTransactionCount (from ParseResult.Rows.Count)
- [ObservableProperty] bool _isImporting (for Step 5 progress state)
- [ObservableProperty] int _importProgress, _importTotal (for progress bar)
- [ObservableProperty] string _importStatusMessage
- Update GoNext: when on Summary step and clicking "Import", set CurrentStep to Progress and set IsImporting = true
- Import execution logic will be added in Phase 3 - for now, just show "Import not yet implemented" message after 1 second delay

In ImportWizardView.axaml Step 4 DataTemplate (Summary):
- Display summary card with:
  - File path
  - Total transactions to import
  - New accounts count
  - New categories count
  - Existing accounts count
  - Existing categories count
- Confirmation text: "Click Import to begin importing {0} transactions"
- Warning about stopping background jobs during import (as mentioned in PROJECT.md)

In ImportWizardView.axaml Step 5 DataTemplate (Progress):
- ProgressBar bound to ImportProgress/ImportTotal
- Status message bound to ImportStatusMessage
- Hide Back/Cancel buttons when IsImporting = true
- Show completion message when done

Add localization strings:
- ImportWizard_Summary: "Import Summary" / "Resumo da Importacao"
- ImportWizard_TotalTransactions: "{0} transactions to import" / "{0} transacoes para importar"
- ImportWizard_ConfirmImport: "Click Import to begin importing {0} transactions." / "Clique em Importar para comecar a importar {0} transacoes."
- ImportWizard_BackgroundJobWarning: "Background jobs will be paused during import." / "Tarefas em segundo plano serao pausadas durante a importacao."
- ImportWizard_Importing: "Importing..." / "Importando..."
- ImportWizard_ImportComplete: "Import complete!" / "Importacao completa!"
- ImportWizard_ImportNotImplemented: "Import execution will be implemented in Phase 3" / "Execucao da importacao sera implementada na Fase 3"
  </action>
  <verify>Step 4 shows summary with all counts, clicking Import goes to Step 5 with placeholder message</verify>
  <done>Steps 4-5 complete: Summary shows all import details, Progress step ready for Phase 3 implementation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build Valt.sln` succeeds without errors
- [ ] `dotnet test` passes (no regressions from Phase 1 tests)
- [ ] Step 1: Can select CSV file, see valid row count, download template
- [ ] Step 1: Parse errors displayed if CSV has issues
- [ ] Step 2: Shows account mappings with New/Existing status
- [ ] Step 3: Shows category mappings with New/Existing status
- [ ] Step 4: Shows complete summary with all counts
- [ ] Step 5: Shows progress placeholder, ready for Phase 3
- [ ] Navigation works correctly through all 5 steps
- [ ] All user-facing strings localized in both en-US and pt-BR
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Import wizard fully functional through all 5 steps
- Phase 2 complete, ready for Phase 3 (Import Execution)
</success_criteria>

<output>
After completion, create `.planning/phases/02-import-wizard-ui/02-02-SUMMARY.md`

Include:
- All files created/modified
- Any deviations from plan
- Issues encountered
- "Phase 2 complete, ready for Phase 3"
</output>
