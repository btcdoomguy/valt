---
phase: 01-csv-parser-template
plan: 01
type: execute
---

<objective>
Build CSV parsing service and sample template generator for transaction import.

Purpose: Enable parsing of user-provided CSV files into intermediate DTOs that Phase 2 (Import Wizard) will use to map accounts and preview transactions before import.
Output: Working CsvImportParser service, CsvTemplateGenerator service, and comprehensive unit tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./01-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

**Codebase patterns:**
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**Existing service registration pattern:**
@src/Valt.Infra/Extensions.cs

**Transaction detail types (target domain objects):**
@src/Valt.Core/Modules/Budget/Transactions/Details/TransactionDetails.cs
@src/Valt.Core/Modules/Budget/Transactions/Details/FiatDetails.cs
@src/Valt.Core/Modules/Budget/Transactions/Details/BitcoinDetails.cs
@src/Valt.Core/Modules/Budget/Transactions/Details/FiatToFiatDetails.cs
@src/Valt.Core/Modules/Budget/Transactions/Details/BitcoinToBitcoinDetails.cs
@src/Valt.Core/Modules/Budget/Transactions/Details/FiatToBitcoinDetails.cs
@src/Valt.Core/Modules/Budget/Transactions/Details/BitcoinToFiatDetails.cs

**Value objects:**
@src/Valt.Core/Common/BtcValue.cs
@src/Valt.Core/Common/FiatValue.cs
@src/Valt.Core/Common/FiatCurrency.cs

**Test builder pattern:**
@tests/Valt.Tests/Builders/TransactionBuilder.cs

**CSV column format (strict):**
- date: Transaction date (yyyy-MM-dd)
- description: Transaction name
- amount: From account amount (decimal, negative = debit, positive = credit)
- account: From account name (required)
- to_account: To account name (optional, for transfers/exchanges)
- to_amount: To account amount (optional, for exchanges with different amounts)
- category: Category name

**Transaction type inference rules:**
1. Bitcoin-only (account ends with "[btc]", no to_account): BitcoinDetails
2. Fiat-only (account with currency code, no to_account): FiatDetails
3. Bitcoin-to-Bitcoin (both accounts end with "[btc]"): BitcoinToBitcoinDetails
4. Fiat-to-Fiat (both accounts have currency codes, same or different): FiatToFiatDetails
5. Fiat-to-Bitcoin (account has currency, to_account ends with "[btc]"): FiatToBitcoinDetails
6. Bitcoin-to-Fiat (account ends with "[btc]", to_account has currency): BitcoinToFiatDetails

**Account naming convention:**
- Fiat: "Account Name [USD]", "Account Name [BRL]" etc.
- Bitcoin: "Account Name [btc]"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV parsing service with DTOs</name>
  <files>
    src/Valt.Infra/Services/CsvImport/CsvImportRow.cs
    src/Valt.Infra/Services/CsvImport/CsvImportResult.cs
    src/Valt.Infra/Services/CsvImport/ICsvImportParser.cs
    src/Valt.Infra/Services/CsvImport/CsvImportParser.cs
  </files>
  <action>
    Create CSV import infrastructure:

    1. **CsvImportRow.cs** - Record representing one parsed CSV row:
       - `DateOnly Date`
       - `string Description`
       - `decimal Amount` (signed: negative=debit, positive=credit)
       - `string AccountName` (required)
       - `string? ToAccountName` (optional)
       - `decimal? ToAmount` (optional)
       - `string CategoryName`
       - `int LineNumber` (for error reporting)

    2. **CsvImportResult.cs** - Result wrapper:
       - `bool Success`
       - `IReadOnlyList<CsvImportRow> Rows`
       - `IReadOnlyList<string> Errors` (line-specific parse errors)
       - Static factory methods: `Success(rows)`, `Failure(errors)`

    3. **ICsvImportParser.cs** - Interface:
       - `CsvImportResult Parse(Stream csvStream)`
       - `CsvImportResult Parse(string csvContent)`

    4. **CsvImportParser.cs** - Implementation using CsvHelper:
       - Use `CsvConfiguration` with `InvariantCulture`
       - Map CSV columns: date, description, amount, account, to_account, to_amount, category
       - Validate required fields (date, description, amount, account, category)
       - Collect row-level errors without throwing (continue parsing)
       - Handle empty to_account and to_amount as null
       - Parse date as DateOnly (yyyy-MM-dd format)
       - Track line numbers for error messages

    **Avoid:** Don't infer transaction types yet - that's Phase 2's job. Parser only produces raw DTOs.
    **Avoid:** Don't create accounts or validate account names exist - just parse the CSV structure.
  </action>
  <verify>
    - Files compile: `dotnet build src/Valt.Infra/Valt.Infra.csproj`
    - No new warnings or errors
  </verify>
  <done>
    - CsvImportRow record captures all CSV columns
    - CsvImportResult wraps success/failure with errors
    - CsvImportParser uses CsvHelper to parse CSV content
    - Parser handles missing optional fields gracefully
    - Line numbers included for error reporting
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSV template generator</name>
  <files>
    src/Valt.Infra/Services/CsvImport/ICsvTemplateGenerator.cs
    src/Valt.Infra/Services/CsvImport/CsvTemplateGenerator.cs
  </files>
  <action>
    Create template generator that produces sample CSV demonstrating all 6 transaction types:

    1. **ICsvTemplateGenerator.cs** - Interface:
       - `string GenerateTemplate()` - Returns CSV string content
       - `void SaveTemplate(string filePath)` - Writes to file

    2. **CsvTemplateGenerator.cs** - Implementation:
       - Use CsvHelper to write properly formatted CSV
       - Include header row: date,description,amount,account,to_account,to_amount,category
       - Generate 6 sample rows (one per transaction type):

       ```
       date,description,amount,account,to_account,to_amount,category
       2024-01-15,Grocery shopping,-150.00,Checking [USD],,,Food
       2024-01-16,Salary,5000.00,Savings [BRL],,,Income
       2024-01-17,Stack sats,-500.00,Checking [USD],Hardware Wallet [btc],0.00850000,Investment
       2024-01-18,Sold bitcoin,-0.01000000,Hardware Wallet [btc],Checking [EUR],450.00,Trading
       2024-01-19,Transfer to savings,-1000.00,Checking [USD],Savings [USD],1000.00,Transfer
       2024-01-20,Consolidate bitcoin,-0.05000000,Exchange Wallet [btc],Hardware Wallet [btc],0.05000000,Transfer
       2024-01-21,Bitcoin income,0.00100000,Hardware Wallet [btc],,,Income
       ```

       - Use InvariantCulture for decimal formatting (dot separator)
       - Bitcoin amounts use 8 decimal places, fiat uses 2

    **Note:** Template serves as user documentation - each row demonstrates one transaction type.
  </action>
  <verify>
    - Files compile: `dotnet build src/Valt.Infra/Valt.Infra.csproj`
    - Template content includes all 6 transaction types
  </verify>
  <done>
    - ICsvTemplateGenerator interface defined
    - CsvTemplateGenerator produces valid CSV with header
    - Sample rows cover: FiatDetails (expense), FiatDetails (income), FiatToBitcoinDetails, BitcoinToFiatDetails, FiatToFiatDetails, BitcoinToBitcoinDetails, BitcoinDetails
    - Decimal formatting uses invariant culture
  </done>
</task>

<task type="auto">
  <name>Task 3: Register services and add unit tests</name>
  <files>
    src/Valt.Infra/Extensions.cs
    tests/Valt.Tests/CsvImport/CsvImportParserTests.cs
    tests/Valt.Tests/CsvImport/CsvTemplateGeneratorTests.cs
  </files>
  <action>
    1. **Register services in Extensions.cs:**
       - Add in the Services section: `services.AddSingleton<ICsvImportParser, CsvImportParser>()`
       - Add: `services.AddSingleton<ICsvTemplateGenerator, CsvTemplateGenerator>()`

    2. **CsvImportParserTests.cs** - Parser unit tests:
       - Test: Should_Parse_Valid_Csv_With_All_Fields
       - Test: Should_Parse_Csv_With_Optional_Fields_Empty
       - Test: Should_Return_Error_For_Missing_Required_Field
       - Test: Should_Return_Error_For_Invalid_Date_Format
       - Test: Should_Return_Error_For_Invalid_Amount_Format
       - Test: Should_Include_Line_Number_In_Error_Messages
       - Test: Should_Handle_Multiple_Rows
       - Use NUnit [Test] attribute, follow existing test conventions

    3. **CsvTemplateGeneratorTests.cs** - Generator unit tests:
       - Test: Should_Generate_Template_With_Header_Row
       - Test: Should_Generate_Template_With_All_Transaction_Types
       - Test: Template_Should_Be_Parseable_By_CsvImportParser (round-trip test)

    **Test pattern:** Use Arrange-Act-Assert with clear comments. No builders needed (testing infrastructure services, not domain objects).
  </action>
  <verify>
    - All tests pass: `dotnet test tests/Valt.Tests/Valt.Tests.csproj --filter "FullyQualifiedName~CsvImport"`
    - Build succeeds: `dotnet build Valt.sln`
  </verify>
  <done>
    - Services registered in DI container
    - Parser tests cover happy path and error cases
    - Generator tests verify template structure
    - Round-trip test confirms template is parseable
    - All tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build Valt.sln` succeeds without errors
- [ ] `dotnet test tests/Valt.Tests/Valt.Tests.csproj --filter "FullyQualifiedName~CsvImport"` passes all tests
- [ ] CsvImportParser correctly parses valid CSV content
- [ ] CsvTemplateGenerator produces parseable CSV
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript/C# errors introduced
- Services registered and injectable
- Tests provide coverage for parser edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/01-csv-parser-template/01-01-SUMMARY.md`:

# Phase 1 Plan 1: CSV Parser & Template Summary

**[Substantive one-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.cs` - Description
- `path/to/another.cs` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 1 complete, ready for Phase 2 (Import Wizard UI)
</output>
