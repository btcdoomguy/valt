---
phase: 03-import-execution
plan: 01
type: execute
---

<objective>
Create the CsvImportExecutor service that handles transaction import from parsed CSV data.

Purpose: Implement the core import logic that creates accounts, categories, and transactions from CSV rows.
Output: ICsvImportExecutor service with full import capability.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-csv-parser-template/01-01-SUMMARY.md
@.planning/phases/02-import-wizard-ui/02-02-SUMMARY.md

# Key source files:
@src/Valt.Infra/Services/CsvImport/CsvImportRow.cs
@src/Valt.Infra/Services/CsvImport/CsvImportResult.cs
@src/Valt.UI/Views/Main/Modals/ImportWizard/Models/AccountMappingItem.cs
@src/Valt.UI/Views/Main/Modals/ImportWizard/Models/CategoryMappingItem.cs
@src/Valt.Core/Modules/Budget/Transactions/Transaction.cs
@src/Valt.Core/Modules/Budget/Transactions/Details/TransactionDetails.cs
@src/Valt.Core/Modules/Budget/Accounts/FiatAccount.cs
@src/Valt.Core/Modules/Budget/Accounts/BtcAccount.cs
@src/Valt.Core/Modules/Budget/Categories/Category.cs

**Tech stack available:** CsvHelper, CommunityToolkit.Mvvm, LiteDB
**Established patterns:** Repository pattern, Domain events, Factory methods (New/Create)
**Constraining decisions:**
- Phase 1: Parser collects row-level errors, supports partial success
- Phase 2: Account matching by clean name (case-insensitive), category matching by SimpleName or Name
- Phase 2: AccountMappingItem has IsNew, IsBtcAccount, Currency properties
- Phase 2: Placeholder import completes immediately - this plan implements real logic
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ICsvImportExecutor interface and result types</name>
  <files>
    src/Valt.Infra/Services/CsvImport/ICsvImportExecutor.cs,
    src/Valt.Infra/Services/CsvImport/CsvImportExecutionResult.cs,
    src/Valt.Infra/Services/CsvImport/CsvImportProgress.cs
  </files>
  <action>
Create the interface and supporting types:

1. **CsvImportProgress** - Progress callback model:
   - int CurrentRow, int TotalRows
   - string CurrentAction (e.g., "Creating accounts...", "Importing transactions...")
   - int Percentage (computed)

2. **CsvImportExecutionResult** - Result of execution:
   - bool Success
   - int TransactionsCreated, AccountsCreated, CategoriesCreated
   - List<string> Errors (row-level errors during import)
   - static Success/Failure factory methods

3. **ICsvImportExecutor** - Main interface:
   - Task<CsvImportExecutionResult> ExecuteAsync(
       IReadOnlyList<CsvImportRow> rows,
       IReadOnlyList<AccountMappingItem> accountMappings,
       IReadOnlyList<CategoryMappingItem> categoryMappings,
       IProgress<CsvImportProgress>? progress = null,
       CancellationToken cancellationToken = default)

Use records for immutable data types. Place in Valt.Infra/Services/CsvImport/ namespace.
  </action>
  <verify>dotnet build src/Valt.Infra/Valt.Infra.csproj succeeds</verify>
  <done>ICsvImportExecutor interface defined, CsvImportExecutionResult and CsvImportProgress types created</done>
</task>

<task type="auto">
  <name>Task 2: Implement CsvImportExecutor with account/category/transaction creation</name>
  <files>src/Valt.Infra/Services/CsvImport/CsvImportExecutor.cs</files>
  <action>
Implement CsvImportExecutor class with full import logic:

**Constructor dependencies:**
- IAccountRepository, ICategoryRepository, ITransactionRepository

**ExecuteAsync implementation:**

1. **Phase 1 - Create new accounts** (report progress "Creating accounts..."):
   - For each AccountMappingItem where IsNew == true:
     - Parse clean name (strip bracket suffix like "[USD]")
     - If IsBtcAccount: Create BtcAccount.New(name, currencyNickname: "", visible: true, Icon.Empty, BtcValue.Empty)
     - If Fiat: Parse Currency from bracket suffix, get FiatCurrency.GetFromCode(), create FiatAccount.New(...)
     - Save via IAccountRepository.SaveAccountAsync()
     - Track mapping: csvAccountName → AccountId (for transaction creation)
   - Update existing account mappings with their AccountId from ExistingAccount.Id

2. **Phase 2 - Create new categories** (report progress "Creating categories..."):
   - For each CategoryMappingItem where IsNew == true:
     - Create Category.New(name, Icon.Empty, parentId: null)
     - Save via ICategoryRepository.SaveCategoryAsync()
     - Track mapping: csvCategoryName → CategoryId
   - Update existing category mappings with their CategoryId from ExistingCategory.Id

3. **Phase 3 - Create transactions** (report progress "Importing transaction X of Y..."):
   - For each CsvImportRow:
     - Look up fromAccountId from account mapping (by CsvImportRow.AccountName)
     - Look up toAccountId if ToAccountName present
     - Look up categoryId from category mapping
     - Determine account types (BTC vs Fiat) from account mapping
     - **Infer transaction type and create TransactionDetails:**
       - No ToAccount + Fiat → FiatDetails(accountId, Math.Abs(amount), credit: amount > 0)
       - No ToAccount + BTC → BitcoinDetails(accountId, BtcValue.ParseSats(Math.Abs(amount)), credit: amount > 0)
       - ToAccount + both Fiat → FiatToFiatDetails(from, to, fromAmount, toAmount ?? fromAmount)
       - ToAccount + both BTC → BitcoinToBitcoinDetails(from, to, BtcValue.ParseSats(Math.Abs(amount)))
       - ToAccount + Fiat→BTC → FiatToBitcoinDetails(fiatAccountId, btcAccountId, FiatValue.New(Math.Abs(amount)), BtcValue.ParseSats(Math.Abs(toAmount)))
       - ToAccount + BTC→Fiat → BitcoinToFiatDetails(btcAccountId, fiatAccountId, BtcValue.ParseSats(Math.Abs(amount)), FiatValue.New(Math.Abs(toAmount)))
     - Create Transaction.New(date, name, categoryId, details, notes: null, fixedExpense: null)
     - Save via ITransactionRepository.SaveTransactionAsync()
     - Report progress after each transaction
   - Wrap each row in try/catch - collect errors but continue (partial success)

4. **Return CsvImportExecutionResult** with counts and any errors

**Important:** BtcValue and FiatValue throw on negative values, so always use Math.Abs() when creating them. The credit/debit direction is indicated by the Credit property on FiatDetails/BitcoinDetails, or by which account is "from" vs "to" in transfers.

**Account name parsing helper:** Extract clean name (strip "[...]" suffix) to find matching account.
  </action>
  <verify>dotnet build src/Valt.Infra/Valt.Infra.csproj succeeds</verify>
  <done>CsvImportExecutor fully implements account creation, category creation, and transaction creation with progress reporting</done>
</task>

<task type="auto">
  <name>Task 3: Register CsvImportExecutor in DI container</name>
  <files>src/Valt.Infra/Extensions.cs</files>
  <action>
Add service registration in AddValtInfrastructure():
- services.AddScoped&lt;ICsvImportExecutor, CsvImportExecutor&gt;();

Place near other CsvImport service registrations (ICsvImportParser, ICsvTemplateGenerator).
  </action>
  <verify>dotnet build Valt.sln succeeds</verify>
  <done>ICsvImportExecutor registered in DI container</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build Valt.sln` succeeds without errors
- [ ] ICsvImportExecutor interface is well-defined with progress callback support
- [ ] CsvImportExecutor handles all 6 transaction types correctly
- [ ] Account and category creation uses correct domain factories (New methods)
- [ ] Service is registered in DI container
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- CsvImportExecutor creates accounts, categories, and transactions from CSV data
</success_criteria>

<output>
After completion, create `.planning/phases/03-import-execution/03-01-SUMMARY.md`
</output>
