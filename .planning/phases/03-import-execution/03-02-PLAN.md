---
phase: 03-import-execution
plan: 02
type: execute
---

<objective>
Integrate CsvImportExecutor with ImportWizardViewModel, add background job pause/resume, and create unit tests.

Purpose: Complete the import wizard by connecting the UI to the executor service with proper background job handling.
Output: Fully functional import wizard with tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-import-execution/03-01-PLAN.md

# Key source files:
@src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardViewModel.cs
@src/Valt.Infra/Kernel/BackgroundJobs/BackgroundJobManager.cs
@src/Valt.Infra/Services/CsvImport/ICsvImportExecutor.cs

**Tech stack available:** CsvHelper, CommunityToolkit.Mvvm, NUnit, NSubstitute
**Established patterns:** Repository pattern, BackgroundJobManager.StopAll()/StartAllJobs()
**Constraining decisions:**
- PROJECT.md: Stop background jobs during import, restart after completion
- Phase 2: Placeholder import just sets progress to 100% - replace with real logic
- Phase 3 Plan 1: CsvImportExecutor provides ExecuteAsync with IProgress callback
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ImportWizardViewModel to use CsvImportExecutor</name>
  <files>src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardViewModel.cs</files>
  <action>
Update the ViewModel to integrate with CsvImportExecutor:

1. **Add new constructor dependency:**
   - ICsvImportExecutor _csvImportExecutor
   - BackgroundJobManager _backgroundJobManager
   - Update DI constructor to accept both (add after existing parameters)
   - Design-time constructor remains unchanged

2. **Replace StartImportAsync() placeholder implementation:**
   ```csharp
   private async Task StartImportAsync()
   {
       TotalToImport = ValidRowCount;
       ImportedCount = 0;
       ImportProgress = 0;
       ImportStatusMessage = language.ImportWizard_Importing;

       // Stop background jobs during import
       await _backgroundJobManager!.StopAll();

       try
       {
           var progress = new Progress<CsvImportProgress>(p =>
           {
               ImportProgress = p.Percentage;
               ImportedCount = p.CurrentRow;
               ImportStatusMessage = p.CurrentAction;
           });

           var result = await _csvImportExecutor!.ExecuteAsync(
               ParseResult!.Rows,
               AccountMappings.ToList(),
               CategoryMappings.ToList(),
               progress);

           if (result.Success)
           {
               ImportStatusMessage = language.ImportWizard_ImportComplete;
               ImportProgress = 100;
           }
           else
           {
               ImportStatusMessage = $"Import completed with errors: {result.Errors.Count} issues";
               // Could show errors in a list, but for MVP just show count
           }
       }
       finally
       {
           // Restart background jobs
           _backgroundJobManager.StartAllJobs(BackgroundJobTypes.Essential);
           _backgroundJobManager.StartAllJobs(BackgroundJobTypes.Optional, triggerInitialRun: false);
       }
   }
   ```

3. **Add required usings:**
   - using Valt.Infra.Services.CsvImport;
   - using Valt.Infra.Kernel.BackgroundJobs;

4. **Update DI registration in src/Valt.UI/Extensions.cs:**
   - ImportWizardViewModel now needs BackgroundJobManager injected
   - Ensure BackgroundJobManager is registered as singleton (check if already done)
  </action>
  <verify>dotnet build Valt.sln succeeds</verify>
  <done>ImportWizardViewModel calls CsvImportExecutor.ExecuteAsync with progress updates and background job pause/resume</done>
</task>

<task type="auto">
  <name>Task 2: Create CsvImportExecutor unit tests</name>
  <files>tests/Valt.Tests/CsvImport/CsvImportExecutorTests.cs</files>
  <action>
Create comprehensive unit tests for CsvImportExecutor:

**Test setup:**
- Use NSubstitute to mock IAccountRepository, ICategoryRepository, ITransactionRepository
- Create helper methods to build CsvImportRow, AccountMappingItem, CategoryMappingItem test data

**Test cases:**

1. **Should_Create_New_Fiat_Account_When_IsNew**
   - Given: AccountMappingItem with IsNew=true, IsBtcAccount=false, Currency="USD"
   - When: ExecuteAsync called
   - Then: IAccountRepository.SaveAccountAsync called with FiatAccount having correct currency

2. **Should_Create_New_Btc_Account_When_IsNew**
   - Given: AccountMappingItem with IsNew=true, IsBtcAccount=true
   - When: ExecuteAsync called
   - Then: IAccountRepository.SaveAccountAsync called with BtcAccount

3. **Should_Create_New_Category_When_IsNew**
   - Given: CategoryMappingItem with IsNew=true
   - When: ExecuteAsync called
   - Then: ICategoryRepository.SaveCategoryAsync called with Category

4. **Should_Create_FiatDetails_Transaction_For_Single_Fiat_Account**
   - Given: Row with AccountName="Checking [USD]", no ToAccountName, Amount=-100
   - When: ExecuteAsync called
   - Then: Transaction created with FiatDetails, Credit=false, Amount=100

5. **Should_Create_FiatDetails_Credit_For_Positive_Amount**
   - Given: Row with AccountName="Checking [USD]", Amount=500
   - When: ExecuteAsync called
   - Then: Transaction created with FiatDetails, Credit=true

6. **Should_Create_BitcoinDetails_Transaction_For_Single_Btc_Account**
   - Given: Row with AccountName="Wallet [btc]", no ToAccountName, Amount=100000 (sats)
   - When: ExecuteAsync called
   - Then: Transaction created with BitcoinDetails

7. **Should_Create_FiatToFiat_Transfer**
   - Given: Row with both accounts fiat, ToAccountName present
   - Then: Transaction created with FiatToFiatDetails

8. **Should_Create_FiatToBitcoin_Exchange**
   - Given: Row with FromAccount fiat, ToAccount BTC
   - Then: Transaction created with FiatToBitcoinDetails

9. **Should_Create_BitcoinToFiat_Exchange**
   - Given: Row with FromAccount BTC, ToAccount fiat
   - Then: Transaction created with BitcoinToFiatDetails

10. **Should_Report_Progress_During_Import**
    - Given: 3 rows to import
    - When: ExecuteAsync called with IProgress
    - Then: Progress reported with increasing percentage

11. **Should_Continue_On_Row_Error_And_Report_Partial_Success**
    - Given: One row that would cause an exception (e.g., invalid data)
    - When: ExecuteAsync called
    - Then: Other rows still imported, errors collected in result

12. **Should_Use_Existing_Account_Id_When_Not_New**
    - Given: AccountMappingItem with IsNew=false, ExistingAccount set
    - When: ExecuteAsync called
    - Then: Transaction uses ExistingAccount.Id, no new account created

Use NUnit [Test] attribute and Assert.That() style assertions.
  </action>
  <verify>dotnet test --filter "FullyQualifiedName~CsvImportExecutorTests" passes</verify>
  <done>12+ unit tests covering account creation, category creation, all 6 transaction types, progress reporting, and error handling</done>
</task>

<task type="auto">
  <name>Task 3: Add localization strings for import progress messages</name>
  <files>
    src/Valt.UI/Lang/language.resx,
    src/Valt.UI/Lang/language.pt-BR.resx,
    src/Valt.UI/Lang/language.Designer.cs
  </files>
  <action>
Add localization strings for the import progress messages:

**language.resx (English):**
- ImportWizard_CreatingAccounts = "Creating accounts..."
- ImportWizard_CreatingCategories = "Creating categories..."
- ImportWizard_ImportingTransaction = "Importing transaction {0} of {1}..."

**language.pt-BR.resx (Portuguese):**
- ImportWizard_CreatingAccounts = "Criando contas..."
- ImportWizard_CreatingCategories = "Criando categorias..."
- ImportWizard_ImportingTransaction = "Importando transacao {0} de {1}..."

**Update language.Designer.cs** with the new properties (copy pattern from existing properties).

**Update CsvImportExecutor** to use these strings:
- Pass the localized strings via a parameter or use a simpler approach: have the executor return action keys, and the ViewModel translates them
- Simpler: Keep progress messages as simple English strings in the executor (they're technical feedback, not user-facing copy)
- Decision: Use simple English strings in executor since progress messages are transient and technical
  </action>
  <verify>dotnet build Valt.sln succeeds</verify>
  <done>Import progress localization strings added (optional enhancement - executor uses simple strings for MVP)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build Valt.sln` succeeds without errors
- [ ] `dotnet test` passes all tests including new CsvImportExecutorTests
- [ ] Import wizard fully functional end-to-end
- [ ] Background jobs pause during import and resume after
- [ ] Progress updates display in UI during import
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors
- Import wizard creates accounts, categories, and transactions from CSV
- Background jobs properly paused/resumed
- Unit tests provide coverage for executor logic
- Phase 3 complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-import-execution/03-02-SUMMARY.md`

Phase 3 complete - CSV Import Wizard fully functional.
</output>
