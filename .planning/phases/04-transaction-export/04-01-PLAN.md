---
phase: 04-transaction-export
plan: 01
type: execute
---

<objective>
Export all transactions to CSV file matching the import format, enabling round-trip data migration.

Purpose: Allow users to backup their transaction data or migrate to other tools using the same CSV format used for import.
Output: Working export feature accessible from main menu that saves all transactions to a CSV file.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (CSV format established):
@.planning/phases/01-csv-parser-template/01-01-SUMMARY.md

# Existing CSV infrastructure to follow:
@src/Valt.Infra/Services/CsvImport/CsvImportRow.cs
@src/Valt.Infra/Services/CsvImport/CsvTemplateGenerator.cs
@src/Valt.Infra/Services/CsvImport/ICsvTemplateGenerator.cs

# Transaction query patterns:
@src/Valt.Infra/Modules/Budget/Transactions/Queries/ITransactionQueries.cs
@src/Valt.Infra/Modules/Budget/Transactions/Queries/DTOs/TransactionDTO.cs

# UI patterns for file dialogs:
@src/Valt.UI/Views/Main/Modals/ImportWizard/ImportWizardViewModel.cs (DownloadTemplate method)

# Menu integration:
@src/Valt.UI/Views/Main/MainView.axaml
@src/Valt.UI/Views/Main/MainViewModel.cs

**Established patterns:**
- CsvHelper for CSV writing (CultureInfo.InvariantCulture, F2 for fiat, F8 for BTC)
- CSV columns: date, description, amount, account, to_account, to_amount, category
- Account format: "AccountName [CurrencyCode]" for fiat, "AccountName [btc]" for bitcoin
- Amount sign convention: negative = debit (outflow), positive = credit (inflow)
- File save dialog via `StorageProvider.SaveFilePickerAsync`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV export service</name>
  <files>
    src/Valt.Infra/Services/CsvExport/ICsvExportService.cs,
    src/Valt.Infra/Services/CsvExport/CsvExportService.cs,
    src/Valt.Infra/Extensions.cs
  </files>
  <action>
Create new CsvExport service that generates CSV content from transactions:

1. Create interface `ICsvExportService` with method:
   - `Task<string> ExportTransactionsAsync()` - returns CSV content string

2. Create implementation `CsvExportService`:
   - Inject `ITransactionQueries` and `IAccountQueries` to fetch data
   - Use `CsvHelper` with same configuration as `CsvTemplateGenerator`:
     - `CultureInfo.InvariantCulture`
     - Header row: date, description, amount, account, to_account, to_amount, category
   - Fetch ALL transactions (no filter, or date range spanning all history)
   - For each transaction, map to CSV row format:
     - date: YYYY-MM-DD format
     - description: transaction name
     - amount: FromAmountFiat (F2) or FromAmountSats converted to BTC (F8), with sign
     - account: "FromAccountName [FromAccountCurrency]" or "FromAccountName [btc]"
     - to_account: "ToAccountName [ToAccountCurrency]" if transfer, empty otherwise
     - to_amount: ToAmountFiat (F2) or ToAmountSats as BTC (F8), always positive for destination
     - category: CategoryName (use simple name, not "Parent > Child" format)

   Amount sign convention (matches import):
   - FiatDetails: negative if debit (!Credit), positive if credit
   - BitcoinDetails: negative if debit, positive if credit
   - Transfers (FiatToFiat, BtcToBtc, FiatToBtc, BtcToFiat): from_amount negative, to_amount positive

3. Register service in `Extensions.cs` AddServices method:
   `services.AddSingleton<ICsvExportService, CsvExportService>();`

AVOID: Don't use TransactionDTO.FormattedFromAmount - format amounts directly from raw values for CSV compatibility. Use CategoryName from DTO directly (already flattened).
  </action>
  <verify>
    dotnet build src/Valt.Infra/Valt.Infra.csproj succeeds without errors
  </verify>
  <done>
    - ICsvExportService interface exists with ExportTransactionsAsync method
    - CsvExportService implementation generates CSV matching import format
    - Service registered in DI container
    - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add export menu item and command</name>
  <files>
    src/Valt.UI/Views/Main/MainViewModel.cs,
    src/Valt.UI/Views/Main/MainView.axaml,
    src/Valt.UI/Lang/language.resx,
    src/Valt.UI/Lang/language.pt-BR.resx
  </files>
  <action>
Add export functionality to main menu:

1. Add localization strings to language.resx:
   - `Menu_ExportTransactions`: "Export Transactions..."

2. Add Portuguese translation to language.pt-BR.resx:
   - `Menu_ExportTransactions`: "Exportar Transações..."

3. Update MainViewModel.cs:
   - Add constructor parameter: `ICsvExportService csvExportService`
   - Add private field: `private readonly ICsvExportService _csvExportService;`
   - Add command:
     ```csharp
     [RelayCommand]
     private async Task ExportTransactions()
     {
         var window = ... // get main window reference (same pattern as other commands)
         var options = new FilePickerSaveOptions
         {
             Title = "Export Transactions",
             SuggestedFileName = "valt-transactions.csv",
             FileTypeChoices = [
                 new FilePickerFileType("CSV Files") { Patterns = ["*.csv"] }
             ]
         };

         var result = await window.StorageProvider.SaveFilePickerAsync(options);
         if (result is null) return;

         var csv = await _csvExportService.ExportTransactionsAsync();
         await File.WriteAllTextAsync(result.Path.LocalPath, csv);
     }
     ```
   Note: Check existing pattern in MainViewModel for getting window reference (likely via a stored reference or TopLevel.GetTopLevel pattern).

4. Update MainView.axaml:
   Add MenuItem after Import Transactions menu item:
   ```xml
   <MenuItem Header="{x:Static local:language.Menu_ExportTransactions}"
             Command="{Binding ExportTransactionsCommand}">
   </MenuItem>
   ```

AVOID: Don't add a separator between Import and Export - they're related data migration features.
  </action>
  <verify>
    - dotnet build src/Valt.UI/Valt.UI.csproj succeeds
    - Run app and verify: Menu shows "Export Transactions..." option
    - Click Export → file dialog appears with "valt-transactions.csv" suggested name
  </verify>
  <done>
    - Menu item "Export Transactions..." visible under Data menu
    - Clicking triggers file save dialog
    - CSV file saved with all transactions in import-compatible format
    - Both en-US and pt-BR translations present
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `dotnet build Valt.sln` succeeds without errors
- [ ] `dotnet test` passes (no new tests required for MVP, but existing tests must pass)
- [ ] Export menu item visible in application menu
- [ ] Export produces valid CSV file that could be re-imported
- [ ] CSV format matches import template (same columns, same value formats)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Export produces CSV matching import format exactly
- Round-trip viable: exported CSV can be imported back
- Phase 4 complete, milestone v1.1 ready for ship
</success_criteria>

<output>
After completion, create `.planning/phases/04-transaction-export/04-01-SUMMARY.md`:

# Phase 04 Plan 01: Transaction Export Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Phase complete, milestone v1.1 ready for release]
</output>
