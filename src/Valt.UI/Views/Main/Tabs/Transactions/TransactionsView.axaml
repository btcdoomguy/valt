<UserControl x:Name="Root"
             xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:Valt.UI.Lang"
             xmlns:vm1="clr-namespace:Valt.UI.Views.Main.Tabs.Transactions"
             xmlns:models="clr-namespace:Valt.UI.Views.Main.Tabs.Transactions.Models"
             xmlns:controls="clr-namespace:Valt.UI.Views.Main.Tabs.Transactions.Controls"
             mc:Ignorable="d" d:DesignWidth="1800" d:DesignHeight="900"
             MinWidth="900"
             MinHeight="500"
             x:Class="Valt.UI.Views.Main.Tabs.Transactions.TransactionsView"
             x:DataType="vm1:TransactionsViewModel">
    <Design.DataContext>
        <vm1:TransactionsViewModel />
    </Design.DataContext>

    <UserControl.Styles>
        <!-- Style for Move to Group submenu items -->
        <Style Selector="MenuItem#MoveToGroupMenu > MenuItem">
            <Setter Property="Command" Value="{Binding #Root.((vm1:TransactionsViewModel)DataContext).MoveAccountToGroupCommand}" />
            <Setter Property="CommandParameter" Value="{Binding}" />
        </Style>
    </UserControl.Styles>

    <Grid x:Name="MainLayoutGrid">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300" MinWidth="100" /> <!-- Left Column -->
            <ColumnDefinition Width="*" MinWidth="300" />   <!-- Center Column -->
            <ColumnDefinition Width="2" />
            <ColumnDefinition Width="270" MinWidth="270" />   <!-- Right Column -->
        </Grid.ColumnDefinitions>

        <!-- Left Column -->
        <Panel Grid.Column="0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="110" />
                    <RowDefinition Height="*" /> <!-- List -->
                </Grid.RowDefinitions>

                <!-- Total wealth -->
                <Border Grid.Row="0"
                        Background="{DynamicResource Background900Brush}"
                        BorderBrush="{DynamicResource Background700Brush}"
                        Padding="10, 6"
                        BorderThickness="1">
                    <Border.Styles>
                        <Style Selector="TextBlock.wealth-label">
                            <Setter Property="FontSize" Value="{DynamicResource FontSizeNormal}" />
                            <Setter Property="FontWeight" Value="Medium" />
                            <Setter Property="VerticalAlignment" Value="Center" />
                        </Style>
                        <Style Selector="TextBlock.wealth-value">
                            <Setter Property="FontSize" Value="{DynamicResource FontSizeNormal}" />
                            <Setter Property="HorizontalAlignment" Value="Right" />
                            <Setter Property="VerticalAlignment" Value="Center" />
                            <Setter Property="Foreground" Value="{DynamicResource Text100Brush}" />
                        </Style>
                    </Border.Styles>

                    <StackPanel Orientation="Vertical" Spacing="2">
                        <!-- My Stack (BTC) - highlighted -->
                        <Grid ColumnDefinitions="Auto, *" Height="22">
                            <TextBlock Grid.Column="0"
                                       Classes="wealth-label"
                                       Foreground="{DynamicResource Accent300Brush}"
                                       Text="{x:Static local:language.Transactions_MyStack}" />
                            <TextBlock Grid.Column="1"
                                       Classes="wealth-value"
                                       Foreground="{DynamicResource Accent200Brush}"
                                       Text="{Binding DisplayWealthInSats}" />
                        </Grid>

                        <!-- My Other (Fiat) -->
                        <Grid ColumnDefinitions="Auto, *" Height="22">
                            <TextBlock Grid.Column="0"
                                       Classes="wealth-label"
                                       Foreground="{DynamicResource Text400Brush}"
                                       Text="{x:Static local:language.Transactions_MyOther}" />
                            <TextBlock Grid.Column="1"
                                       Classes="wealth-value"
                                       Text="{Binding DisplayWealthInFiat}" />
                        </Grid>

                        <!-- Total in Fiat -->
                        <Grid ColumnDefinitions="Auto, *" Height="22">
                            <TextBlock Grid.Column="0"
                                       Classes="wealth-label"
                                       Foreground="{DynamicResource Text300Brush}"
                                       Text="{x:Static local:language.Transactions_TotalInFiat}" />
                            <TextBlock Grid.Column="1"
                                       Classes="wealth-value"
                                       Text="{Binding DisplayAllWealthInFiat}" />
                        </Grid>

                        <!-- BTC Ratio -->
                        <Grid ColumnDefinitions="Auto, *" Height="22">
                            <TextBlock Grid.Column="0"
                                       Classes="wealth-label"
                                       Foreground="{DynamicResource Text400Brush}"
                                       Text="{x:Static local:language.Transactions_Ratio}" />
                            <TextBlock Grid.Column="1"
                                       Classes="wealth-value"
                                       Foreground="{DynamicResource Accent300Brush}"
                                       Text="{Binding DisplayWealthInBtcRatio}" />
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Accounts List -->
                <Grid Grid.Row="1" RowDefinitions="30, *" Margin="0, 0, 0, 10">
                    <StackPanel Grid.Row="0" Background="Black">
                        <Button FontSize="{DynamicResource FontSizeSmall}" Classes="transparent link" HorizontalAlignment="Right"
                                HorizontalContentAlignment="Right"
                                VerticalAlignment="Stretch" Command="{Binding SelectAllAccountsCommand}"
                                Content="{x:Static local:language.Transactions_ViewAllAccounts}" />
                    </StackPanel>
                    <ListBox Grid.Row="1"
                             x:Name="AccountsList"
                             Classes="accounts"
                             ItemsSource="{Binding AccountListItems}"
                             SelectedItem="{Binding SelectedAccount}"
                             SelectionMode="Single">
                        <ListBox.Styles>
                            <!-- Override padding for account items -->
                            <Style Selector="ListBoxItem">
                                <Setter Property="Padding" Value="5,5,5,0" />
                            </Style>
                        </ListBox.Styles>
                        <ListBox.DataTemplates>
                            <!-- Group Header Template -->
                            <DataTemplate DataType="{x:Type models:AccountGroupHeaderViewModel}">
                                <Border Background="{DynamicResource Background800Brush}"
                                        BorderBrush="{DynamicResource Background600Brush}"
                                        BorderThickness="0,0,0,1"
                                        Padding="8,4"
                                        Margin="-5,-5,-5,0">
                                    <Border.ContextMenu>
                                        <ContextMenu x:DataType="models:AccountGroupHeaderViewModel">
                                            <MenuItem Header="{x:Static local:language.Transactions_EditGroup}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).EditAccountGroupCommand}"
                                                      CommandParameter="{Binding .}" />
                                            <MenuItem Header="{x:Static local:language.Transactions_DeleteGroup}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).DeleteAccountGroupCommand}"
                                                      CommandParameter="{Binding .}" />
                                            <Separator />
                                            <MenuItem Header="{x:Static local:language.Transactions_MoveUp}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).MoveUpAccountGroupCommand}"
                                                      CommandParameter="{Binding .}" />
                                            <MenuItem Header="{x:Static local:language.Transactions_MoveDown}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).MoveDownAccountGroupCommand}"
                                                      CommandParameter="{Binding .}" />
                                        </ContextMenu>
                                    </Border.ContextMenu>
                                    <TextBlock Text="{Binding Name}"
                                               FontSize="{DynamicResource FontSizeSmall}"
                                               Foreground="{DynamicResource Text400Brush}"
                                               VerticalAlignment="Center" />
                                </Border>
                            </DataTemplate>
                            <!-- Account Item Template -->
                            <DataTemplate DataType="{x:Type models:AccountViewModel}">
                                <controls:AccountItemControl DataContext="{Binding}">
                                    <controls:AccountItemControl.ContextMenu>
                                        <ContextMenu x:DataType="models:AccountViewModel">
                                            <MenuItem Header="{x:Static local:language.Transactions_Edit}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).EditAccountCommand}"
                                                      CommandParameter="{Binding .}" />
                                            <MenuItem Header="{x:Static local:language.Transactions_Hide}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).HideAccountCommand}"
                                                      CommandParameter="{Binding .}"
                                                      IsVisible="{Binding Visible}" />
                                            <MenuItem Header="{x:Static local:language.Transactions_Show}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).ShowAccountCommand}"
                                                      CommandParameter="{Binding .}"
                                                      IsVisible="{Binding IsHidden}" />
                                            <MenuItem Header="{x:Static local:language.Transactions_Delete}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).DeleteAccountCommand}"
                                                      CommandParameter="{Binding .}" />
                                            <Separator />
                                            <MenuItem Header="{x:Static local:language.Transactions_MoveUp}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).MoveUpAccountCommand}"
                                                      CommandParameter="{Binding .}" />
                                            <MenuItem Header="{x:Static local:language.Transactions_MoveDown}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).MoveDownAccountCommand}"
                                                      CommandParameter="{Binding .}" />
                                            <Separator IsVisible="{Binding !GroupId, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                            <!-- Move to Group submenu - visible only when account is not in a group -->
                                            <MenuItem x:Name="MoveToGroupMenu"
                                                      Header="{x:Static local:language.Transactions_MoveToGroup}"
                                                      IsVisible="{Binding GroupId, Converter={x:Static StringConverters.IsNullOrEmpty}}"
                                                      SubmenuOpened="MoveToGroupMenu_OnSubmenuOpened"
                                                      ItemsSource="{Binding #Root.((vm1:TransactionsViewModel)DataContext).AvailableGroups}" />
                                            <!-- Remove from Group - visible only when account is in a group -->
                                            <MenuItem Header="{x:Static local:language.Transactions_RemoveFromGroup}"
                                                      Command="{Binding #Root.((vm1:TransactionsViewModel)DataContext).RemoveAccountFromGroupCommand}"
                                                      CommandParameter="{Binding .}"
                                                      IsVisible="{Binding GroupId, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                        </ContextMenu>
                                    </controls:AccountItemControl.ContextMenu>
                                </controls:AccountItemControl>
                            </DataTemplate>
                        </ListBox.DataTemplates>
                    </ListBox>
                </Grid>

                <Border Grid.Row="1"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Bottom"
                        Padding="10"
                        Margin="0,0,10,18">
                    <Button Classes="rounded" Content="&#xE145;">
                        <Button.Flyout>
                            <MenuFlyout>
                                <MenuItem Header="{x:Static local:language.Transactions_AddAccount}"
                                          Command="{Binding AddAccountCommand}" />
                                <MenuItem Header="{x:Static local:language.Transactions_AddAccountGroup}"
                                          Command="{Binding AddAccountGroupCommand}" />
                            </MenuFlyout>
                        </Button.Flyout>
                    </Button>
                </Border>
            </Grid>
        </Panel>

        <!-- Center Column -->

        <ContentControl x:Name="SubContentControl"
                        Content="{Binding SubContent}"
                        Grid.Column="1"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch" />

        <!-- GridSplitter -->
        <GridSplitter Grid.Column="2"
                      Width="2"
                      Background="{DynamicResource Background800Color}"
                      ResizeDirection="Columns"
                      ResizeBehavior="PreviousAndNext" />

        <!-- Right Column -->
        <Panel Grid.Column="3">
            <Grid x:Name="RightPanelGrid" Margin="0, 0, 10, 10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="80" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="8" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <!-- Current Month/Year Header -->
                <TextBlock Grid.Row="0"
                           Text="{Binding CurrentMonthYearDisplay}"
                           FontSize="{DynamicResource FontSizeMedium}"
                           FontWeight="SemiBold"
                           FontFamily="{DynamicResource GeistMono}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Bottom"
                           Margin="0, 0, 0, 8" />

                <!-- Fixed Expenses Panel -->
                <vm1:FixedExpensesPanelView Grid.Row="1" x:Name="FixedExpensesPanel" />

                <!-- GridSplitter between panels -->
                <GridSplitter Grid.Row="2"
                              Height="4"
                              Background="Transparent"
                              ResizeDirection="Rows"
                              ResizeBehavior="PreviousAndNext" />

                <!-- Goals Panel -->
                <vm1:GoalsPanelView Grid.Row="3" x:Name="GoalsPanel" />
            </Grid>
        </Panel>
    </Grid>
</UserControl>
